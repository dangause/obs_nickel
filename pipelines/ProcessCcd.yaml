# pipelines/ProcessCcd.yaml
description: ISR + Image Calibration
tasks:
  isr:
    class: lsst.ip.isr.IsrTask
    config:
      doOverscan: True
      doBias: True
      doFlat: True
      doDark: False
      doDefect: False
      doSuspect: True
      doWrite: True
      doTrimToMatchCalib: True
      doVignette: True

  calibrateImage:
    class: lsst.pipe.tasks.calibrateImage.CalibrateImageTask
    config:
      # connections.astrometry_ref_cat: gaia_dr3_20250728
      connections.astrometry_ref_cat: gaia_dr3_20250728
      # connections.photometry_ref_cat: gaia_dr3_20250728
      connections.photometry_ref_cat: panstarrs1_dr2_20250730
      # astrometry.maxFitRms: 10.0  # allow overall worse fits before raising BadAstrometryFit
      # astrometry.matchDistanceSigma: 5.0
      # astrometry.maxMeanDistanceArcsec: 20.0
      # astrometry.maxIter: 5
      # astrometry.doMagnitudeOutlierRejection: true
      # psf_measure_psf.psfDeterminer: "pca"
      # measure_aperture_correction.sourceSelector.science.signalToNoise.minimum: 10.0
      # measure_aperture_correction.minDegreesOfFreedom: 1
      # measure_aperture_correction.allowFailure: ["base_GaussianFlux"]
      astrometry.maxMeanDistanceArcsec: 50.0
      # photometry.match.refFluxField: phot_g_mean_flux
      # astrometry_ref_loader.anyFilterMapsToThis: None
      # astrometry_ref_loader.filterMap: {"b": "gMeanPSFMag", "v": "gMeanPSFMag", "r": "rMeanPSFMag", "i": "iMeanPSFMag", "u": "gMeanPSFMag"}
      photometry_ref_loader.anyFilterMapsToThis: None
      photometry_ref_loader.filterMap: {"b": "gMeanPSFMag", "v": "gMeanPSFMag", "r": "rMeanPSFMag", "i": "iMeanPSFMag", "u": "gMeanPSFMag"}

subsets:
  processCcd:
    - isr
    - calibrateImage

steps:
  - label: processCcd
    sharding_dimensions: visit,detector
